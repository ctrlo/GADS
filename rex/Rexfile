use Rex -feature => [1.4];

use strict;
use warnings;

use feature 'say';

use YAML;

task psql => sub {
    pkg "postgresql", ensure => "present";
    service postgresql => "ensure", "started";
    service postgresql => "ensure", "enabled";
    my $config = YAML::LoadFile('rex/config/gads-config.yml')->{config}
      or die("No config found");
    my $cmd =
        run 'su -c "psql -c \"CREATE USER '
      . $config->{db_user}
      . ' WITH PASSWORD \''
      . $config->{db_pass}
      . '\'\"" postgres';
    say $cmd;
    $cmd =
        run 'su -c "psql -c \"CREATE DATABASE '
      . $config->{db_name}
      . ' OWNER '
      . $config->{db_user}
      . '\"" postgres';
    say $cmd;
    $cmd = run
'su -c "psql linkspace -c \"CREATE EXTENSION IF NOT EXISTS citext WITH SCHEMA public;\"" postgres';
    say $cmd;
};

task libs => sub {
    update_package_db;
    pkg $_, ensure => present
      foreach
      qw/cpanminus liblua5.3-dev gcc g++ libdatetime-format-sqlite-perl libtest-most-perl libdatetime-set-perl libdbix-class-schema-loader-perl libmagic-dev postgresql-client libpng-dev libssl-dev libpq-dev libjson-perl libsession-token-perl libnet-oauth2-authorizationserver-perl libtext-csv-encoded-perl libcrypt-urandom-perl libhtml-scrubber-perl libtext-markdown-perl libwww-form-urlencoded-xs-perl libstring-camelcase-perl libmail-transport-perl liblog-log4perl-perl libplack-perl libdbd-pg-perl libmail-message-perl libmath-random-isaac-xs-perl libdbix-class-helpers-perl libtree-dagnode-perl libmath-round-perl libdatetime-format-dateparse-perl libwww-mechanize-perl libdatetime-format-iso8601-perl libmoox-types-mooselike-perl libmoox-singleton-perl liblist-compare-perl liburl-encode-perl libtie-cache-perl libhtml-fromtext-perl libdata-compare-perl libfile-bom-perl libalgorithm-dependency-perl libdancer-plugin-auth-extensible-perl libfile-libmagic-perl postfix perl libconvert-asn1-perl libmodule-runtime-perl libcrypt-openssl-random-perl libdancer2-perl libinline-perl libdatetime-perl libdatetime-format-strptime-perl liblist-moreutils-perl liblog-report-perl libpdf-table-perl libtest-mocktime-perl libtext-autoformat-perl libyaml-perl libnamespace-clean-perl make nano libaws-signature4-perl libdata-validate-ip-perl libdevel-caller-perl libhash-merge-perl libio-string-perl libsort-naturally-perl libterm-readkey-perl libtext-glob-perl liburi-perl libxml-simple-perl libversion-perl libfile-sharedir-install-perl libio-pty-perl libdigest-hmac-perl libnet-sftp-foreign-perl libnet-openssh-perl libjson-maybexs-perl libcpanel-json-xs-perl/;
};

task cpan => sub {
    run "perl ./bin/output_cpanfile > cpanfile";
    run "cpanm --installdeps . --notest --cpanfile ./cpanfile";
};

task dbconfig => sub {
    say "Loading config from config/gads-config.yml";
    my $config = YAML::LoadFile('rex/config/gads-config.yml')->{config}
      or die("No config found");
    run "psql "
      . $config->{db_name} . " -h "
      . $config->{db_host} . " -U "
      . $config->{db_user}
      . " -c \"CREATE EXTENSION IF NOT EXISTS citext WITH SCHEMA public;\"";
    run "./bin/seed-database.pl --initial_username="
      . $config->{gads_user}
      . " --instance_name="
      . $config->{gads_instance}
      . " --site="
      . $config->{gads_site};
};

task config => sub {
    say "Loading config from config/gads-config.yml";
    my $config = YAML::LoadFile('rex/config/gads-config.yml')
      or die("No config found");
    file "./config.yml",
      content => template( "files/config.yml.tpl", $config );
};

batch setup => 'libs', 'psql', 'cpan', 'config', 'dbconfig';
