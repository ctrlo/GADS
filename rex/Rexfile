use Rex -feature => [1.4];

use strict;
use warnings;

use feature 'say';

use YAML;
use Rex::Commands::SCM;

my $remote = 0;

if($remote) {
  set repository => "gads",
    url => "https://github.com/ctrlo/GADS";

  task clone => sub {
      checkout "gads",
        path=>"/srv/GADS";
  };
}

task psql => sub {
    pkg "postgresql", ensure => "present";
    service postgresql => "ensure", "started";
    service postgresql => "ensure", "enabled";
    my $config = YAML::LoadFile('rex/config/gads-config.yml')->{config}
      or die("No config found");
    my $cmd =
        run 'su -c "psql -c \"CREATE USER '
      . $config->{db_user}
      . ' WITH PASSWORD \''
      . $config->{db_pass}
      . '\'\"" postgres';
    say $cmd;
    $cmd =
        run 'su -c "psql -c \"CREATE DATABASE '
      . $config->{db_name}
      . ' OWNER '
      . $config->{db_user}
      . '\"" postgres';
    say $cmd;
    $cmd = run
'su -c "psql linkspace -c \"CREATE EXTENSION IF NOT EXISTS citext WITH SCHEMA public;\"" postgres';
    say $cmd;
};

task libs => sub {
    update_package_db;
    pkg $_, ensure => present
      foreach
      qw/cpanminus liblua5.3-dev gcc g++ libdatetime-format-sqlite-perl libtest-most-perl libdatetime-set-perl libdbix-class-schema-loader-perl libmagic-dev postgresql-client libpng-dev libssl-dev libpq-dev libjson-perl libsession-token-perl libnet-oauth2-authorizationserver-perl libtext-csv-encoded-perl libcrypt-urandom-perl libhtml-scrubber-perl libtext-markdown-perl libwww-form-urlencoded-xs-perl libstring-camelcase-perl libmail-transport-perl liblog-log4perl-perl libplack-perl libdbd-pg-perl libmail-message-perl libmath-random-isaac-xs-perl libdbix-class-helpers-perl libtree-dagnode-perl libmath-round-perl libdatetime-format-dateparse-perl libwww-mechanize-perl libdatetime-format-iso8601-perl libmoox-types-mooselike-perl libmoox-singleton-perl liblist-compare-perl liburl-encode-perl libtie-cache-perl libhtml-fromtext-perl libdata-compare-perl libfile-bom-perl libalgorithm-dependency-perl libdancer-plugin-auth-extensible-perl libfile-libmagic-perl postfix perl libconvert-asn1-perl libmodule-runtime-perl libcrypt-openssl-random-perl libdancer2-perl libinline-perl libdatetime-perl libdatetime-format-strptime-perl liblist-moreutils-perl liblog-report-perl libpdf-table-perl libtest-mocktime-perl libtext-autoformat-perl libyaml-perl libnamespace-clean-perl make nano libaws-signature4-perl libdata-validate-ip-perl libdevel-caller-perl libhash-merge-perl libio-string-perl libsort-naturally-perl libterm-readkey-perl libtext-glob-perl liburi-perl libxml-simple-perl libversion-perl libfile-sharedir-install-perl libio-pty-perl libdigest-hmac-perl libnet-sftp-foreign-perl libnet-openssh-perl libjson-maybexs-perl libcpanel-json-xs-perl/;
};

task cpan => sub {
  foreach(qw/Algorithm::Dependency::Ordered CGI::Deurl::XS Crypt::URandom CtrlO::Crypt::XkcdPassword CtrlO::PDF DBD::Pg DBIx::Class::Helper::ResultSet::DateMethods1 DBIx::Class::Migration DBIx::Class::ResultClass::HashRefInflator Dancer2 Dancer2::Plugin::Auth::Extensible Dancer2::Plugin::Auth::Extensible::Provider::DBIC Dancer2::Plugin::DBIC Dancer2::Plugin::LogReport Data::Compare Date::Holidays::GB DateTime DateTime::Event::Random DateTime::Format::CLDR DateTime::Format::DateManip DateTime::Format::ISO8601 DateTime::Format::SQLite DateTime::Format::Strptime DateTime::Span File::BOM File::LibMagic HTML::FromText HTML::Scrubber Inline::Lua List::Compare List::MoreUtils List::Util Log::Log4perl Log::Report Mail::Message Mail::Transport::Sendmail Math::Random::ISAAC::XS Math::Round MooX::Singleton MooX::Types::MooseLike::DateTime Net::OAuth2::AuthorizationServer::PasswordGrant Net::SAML2 PDF::Table Plack Session::Token Starman String::CamelCase Test::MockTime Test::More Text::Autoformat Text::CSV::Encoded Text::Markdown Tie::Cache Tree::DAG_Node URL::Encode WWW::Form::UrlEncoded::XS WWW::Mechanize::Chrome YAML namespace::clean/) {
    my $install = run "cpanm --notest --sudo $_";
    say $install;
  }
};

task dbconfig => sub {
    my $prefix=".";
    if ($remote) {
        $prefix = "/srv/GADS";
    }
    say "Loading config from config/gads-config.yml";
    my $config = YAML::LoadFile('rex/config/gads-config.yml')->{config}
      or die("No config found");
    run "psql "
      . $config->{db_name} . " -h "
      . $config->{db_host} . " -U "
      . $config->{db_user}
      . " -c \"CREATE EXTENSION IF NOT EXISTS citext WITH SCHEMA public;\"";
    my $result = run "$prefix/bin/seed-database.pl --initial_username="
      . $config->{gads_user}
      . " --instance_name="
      . $config->{gads_instance}
      . " --site="
      . $config->{gads_site};
    say $result;
};

task config => sub {
    my $prefix = ".";
    if ($remote) {
        $prefix = "/srv/GADS";
    }
    say "Loading config from config/gads-config.yml";
    my $config = YAML::LoadFile('rex/config/gads-config.yml')
      or die("No config found");
    file "$prefix/config.yml", content => template( "files/config.yml.tpl", $config );
};

batch setup => 'libs', 'psql', 'cpan', 'config', 'dbconfig';
