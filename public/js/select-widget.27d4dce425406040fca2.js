"use strict";(self.webpackChunklinkspace=self.webpackChunklinkspace||[]).push([[732],{53163:(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});var s=i(17527),a=i(11977),n=i(56197),l=i(74692);class SelectWidgetComponent extends s.uA{constructor(t){super(t),this.el=l(this.element),this.$selectWidget=this.el,this.$widget=this.el.find(".form-control"),this.$trigger=this.$widget.find("[aria-expanded]"),this.$current=this.el.find(".current"),this.$available=this.el.find(".available"),this.$availableItems=this.el.find(".available .answer input"),this.$moreInfoButtons=this.el.find(".available .answer .btn-js-more-info"),this.$target=this.el.find("#"+this.$trigger.attr("aria-controls")),this.$currentItems=this.$current.find("[data-list-item]"),this.$answers=this.el.find(".answer"),this.$fakeInput=null,this.$search=this.el.find(".form-control-search"),this.lastFetchParams=null,this.multi=this.el.hasClass("multi"),this.timeout,this.required=this.el.hasClass("select-widget--required"),this.loadCounter=0,this.initSelectWidget(),this.required&&(0,n.pT)(this.el)}initSelectWidget(){this.updateState(),this.$widget.is("[readonly]")||(this.connect(),this.$widget.unbind("click"),this.$widget.on("click",(()=>{this.handleWidgetClick()})),this.$search.unbind("blur"),this.$search.on("blur",(t=>{this.possibleCloseWidget(t)})),this.$availableItems.unbind("blur"),this.$availableItems.on("blur",(t=>{this.possibleCloseWidget(t)})),this.$moreInfoButtons.unbind("blur"),this.$moreInfoButtons.on("blur",(t=>{this.possibleCloseWidget(t)})),l(document).on("click",(t=>{this.handleDocumentClick(t)})),l(document).keyup((function(t){27==t.keyCode&&this.collapse(this.$widget,this.$trigger,this.$target)})),this.$widget.delegate(".select-widget-value__delete","click",(function(t){t.preventDefault(),t.stopPropagation();const e=t.target.parentElement.getAttribute("data-list-item"),i=document.getElementById(e);i.checked=!1,l(i).parent().trigger("click"),l(i).trigger("change")})),this.$search.unbind("focus",this.expandWidgetHandler),this.$search.on("focus",(t=>{this.expandWidgetHandler(t)})),this.$search.unbind("keydown"),this.$search.on("keydown",(t=>{this.handleKeyDown(t)})),this.$search.unbind("keyup"),this.$search.on("keyup",(t=>{this.handleKeyUp(t)})),this.$search.unbind("click"),this.$search.on("click",(t=>{t.stopPropagation()})))}handleWidgetClick(){"true"===this.$trigger.attr("aria-expanded")?this.collapse(this.$widget,this.$trigger,this.$target):this.expand(this.$widget,this.$trigger,this.$target)}handleDocumentClick(t){!this.el.is(t.target)&&0===this.el.has(t.target).length&&this.collapse(this.$widget,this.$trigger,this.$target)}handleKeyUp(t){const e=l(t.target).val().toLowerCase(),i=this;if(this.$fakeInput=this.$fakeInput||l("<span>").addClass("form-control-search").css("white-space","nowrap"),this.$fakeInput.text(e),this.$search.css("width",this.$fakeInput.insertAfter(this.$search).width()+100),this.$fakeInput.detach(),"typeahead"==this.$selectWidget.data("value-selector")){const t=`/${this.$selectWidget.data("layout-id")}/match/layout/${this.$selectWidget.data("typeahead-id")}`;clearTimeout(this.timeout),this.$available.find(".spinner").removeAttr("hidden"),this.timeout=setTimeout((function(){i.$available.find(".answer").not(".answer--blank").each((function(){const t=l(this);t.find("input:checked").length||t.remove()})),i.updateJson(t+"?noempty=1&q="+e,!0)}),200)}else{let t=!1;l.each(this.$answers,(function(){-1===l(this).find("label")[0].innerHTML.toLowerCase().indexOf(e)?l(this).attr("hidden",""):(t=!0,l(this).removeAttr("hidden",""))})),t?this.$available.find(".has-noresults").attr("hidden",""):this.$available.find(".has-noresults").removeAttr("hidden","")}}handleKeyDown(t){const e=t.which||t.keyCode;switch(this.expand(this.$widget,this.$trigger,this.$target),e){case 38:case 40:{const i=this.$available.find(".answer:not([hidden]) input");let s;t.preventDefault(),s=38===e?i[i.length-1]:i[0],s&&l(s).focus();break}case 13:{t.preventDefault();const e=this.$available.find(".answer:not([hidden]) input").get(0);e&&l(e).parent().trigger("click");break}}}expandWidgetHandler(t){t.stopPropagation(),this.expand(this.$widget,this.$trigger,this.$target)}collapse(t,e){this.$selectWidget.removeClass("select-widget--open"),e.attr("aria-expanded",!1),setTimeout((()=>{this.$search.val(""),this.$target.attr("hidden",""),this.$answers.removeAttr("hidden")}),50)}updateState(){const t=this.$current.children("[data-list-item]:not([hidden])");this.$current.toggleClass("empty",0===t.length)}possibleCloseWidget(t){const e=t.relatedTarget||document.activeElement;this.$selectWidget.find(e).length||!e||l(e).is(".modal, .page, body")||this.$selectWidget.get(0).parentNode===e||this.collapse(this.$widget,this.$trigger,this.$target)}connectMulti(){const t=this;return function(){const e=l(this),i=e.data("list-item"),s=l("#"+i);s.unbind("change"),s.on("change",(i=>{l(i.target).prop("checked")?e.removeAttr("hidden"):e.attr("hidden",""),t.updateState()})),s.unbind("keydown"),s.on("keydown",(function(e){const i=e.which||e.keyCode;switch(i){case 38:case 40:{const a=t.$answers.index(s.closest(".answer"));let n;e.preventDefault(),n=38===i?t.$answers[a-1]:t.$answers[a+1],n&&l(n).find("input").focus();break}case 13:e.preventDefault(),l(this).trigger("click")}}))}}connectSingle(){const t=this;this.$currentItems.each(((e,i)=>{const s=l(i),a=s.data("list-item"),n=l("#"+a);n.off("click"),n.on("click",(function(t){t.stopPropagation()})),n.off("change"),n.on("change",(function(){t.$currentItems.each(((t,e)=>{l(e).attr("hidden","")})),n.prop("checked")&&s.removeAttr("hidden"),t.updateState()})),n.parent().unbind("keypress"),n.parent().on("keypress",(t=>{13!==t.keyCode&&32!==t.keyCode||(t.preventDefault(),l(t.target).parent().trigger("click"))})),n.parent().off("click"),n.parent().on("click",(()=>{this.collapse(this.$widget,this.$trigger,this.$target)}))}))}connect(){this.multi?this.$currentItems.each(this.connectMulti()):this.connectSingle()}currentLi(t,e,i,s,a,n){if(t&&!i)return l('<li class="none-selected">blank</li>');const r=l("<li "+(n?"":"hidden")+' data-list-item="'+(i?e+"_"+i:e+"__blank")+'" class="'+(i?"":"current__blank")+'"><span class="widget-value__value"></span><button type="button" class="close select-widget-value__delete" aria-hidden="true" aria-label="delete" title="delete" tabindex="-1">&times</button></li>');return r.data("list-text",s),r.data("list-id",i),r.find("span").html(a),r}availableLi(t,e,i,s,a,n){if(this.multi&&!i)return null;const r=i?e+"_"+i:e+"__blank",h=i?"answer":"answer answer--blank",d=' <div class="details"><button type="button" class="btn btn-small btn-default btn-js-more-info" data-record-id="'+i+'" aria-describedby="lbl-'+r+'" data-target="'+this.el.data("details-modal")+'" data-toggle="modal">Details</button></div>',o=l('<li class="'+h+'"><div class="control"><div class="'+(t?"checkbox":"radio-group__option")+'"><input id="'+r+'" type="'+(t?"checkbox":"radio")+'" name="'+e+'" '+(n?" checked":"")+(this.required&&!this.multi?' required aria-required="true"':"")+' value="'+(i||"")+'" class="'+(t?"":"visually-hidden")+'" aria-labelledby="lbl-'+r+'"> <label id="lbl-'+r+'" for="'+r+'">'+a+"</label></div></div>"+(i?d:"")+"</li>");return o.data("list-text",s),o.data("list-id",i),o}updateJson(t,e){this.loadCounter++;const s=this,n=this.loadCounter;this.$available.find(".spinner").removeAttr("hidden");const r=this.$available.find("input:checked").map((function(){return parseInt(l(this).val())})).get();e||this.$available.find(".answer").remove();const h=this.$selectWidget.data("field");let d=!0;l.getJSON(t,(t=>{if(0===t.error){if(n!=this.loadCounter)return void(d=!1);e?this.$currentItems.filter(":hidden").remove():this.$currentItems.remove();const s=r.includes(NaN);this.multi&&(this.$search.parent().prevAll(".none-selected").remove(),this.$search.parent().before(this.currentLi(this.multi,h,null,"","blank",s)),this.$available.append(this.availableLi(this.multi,h,null,"","blank",s))),l.each(t.records,((t,i)=>{const s=r.includes(i.id);(!e||e&&!s)&&(this.$search.parent().before(this.currentLi(this.multi,h,i.id,i.label,i.html,s)).before(" "),this.$available.append(this.availableLi(this.multi,h,i.id,i.label,i.html,s)))})),this.$currentItems=this.$current.find("[data-list-item]"),this.$available=this.$selectWidget.find(".available"),this.$availableItems=this.$selectWidget.find(".available .answer input"),this.$moreInfoButtons=this.$selectWidget.find(".available .answer .btn-js-more-info"),this.$answers=this.$selectWidget.find(".answer"),this.updateState(),this.connect(),this.$availableItems.on("blur",(t=>{this.possibleCloseWidget(t)})),this.$moreInfoButtons.on("blur",(t=>{this.possibleCloseWidget(t)})),this.$moreInfoButtons.each(((t,e)=>{i.e(998).then(i.bind(i,38697)).then((({default:t})=>{new t(e)}))}))}else{const e=1===t.error?t.message:"Oops! Something went wrong.",i=l('<li class="answer answer--blank alert alert-danger d-flex flex-row justify-content-start"><span class="control"><label>'+e+"</label></span></li>");this.$available.append(i)}})).fail((function(e,i,n){a.m.error("Failed to make request to "+t+": "+i+": "+n);const r=l('<li class="answer answer--blank alert alert-danger"><span class="control"><label>Oops! Something went wrong.</label></span></li>');s.$available.append(r)})).always((function(){d&&s.$available.find(".spinner").attr("hidden","")}))}fetchOptions(){const t=this.$selectWidget.data("filter-endpoint"),e=this.$selectWidget.data("filter-fields"),i=this.$selectWidget.data("submission-token");if(!Array.isArray(e))throw"Invalid data-filter-fields found. It should be a proper JSON array of fields.";const s=["submission-token="+i];l.each(e,(function(t,e){l("input[name="+e+"]").each((function(t,i){const a=l(i);switch(a.attr("type")){case"number":case"text":case"hidden":s.push(e+"="+a.val());break;case"radio":case"checkbox":i.checked&&s.push(e+"="+a.val())}}))}));const a=s.join("&");this.lastFetchParams!==a&&(this.lastFetchParams=null,this.updateJson(t+"?"+a),this.lastFetchParams=a)}expand(t,e,i){if("true"===e.attr("aria-expanded"))return;if(this.$selectWidget.addClass("select-widget--open"),this.$available.find(".spinner").attr("hidden",""),e.attr("aria-expanded",!0),this.$selectWidget.data("filter-endpoint")&&this.$selectWidget.data("filter-endpoint").length)try{this.fetchOptions()}catch(t){a.m.error(t)}const s=t.offset().top,n=s+t.outerHeight(),r=l(window).scrollTop(),h=r+l(window).height()-60,d=s-200>r&&!(n+200<h);i.toggleClass("available--top",d),i.removeAttr("hidden"),this.$search.get(0)!==document.activeElement&&this.$search.focus()}}const r=SelectWidgetComponent}}]);